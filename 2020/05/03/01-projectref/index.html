<!DOCTYPE html><html lang="ja" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="generator" content="https://github.com/azyobuzin/blog"><link rel="stylesheet" href="https://unpkg.com/fork-awesome@~1.2.0/css/fork-awesome.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="/global.css"><meta property="og:site_name" content="あじょろぐ"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@azyobuzin"><title>ProjectReference にバージョン範囲を指定したい | あじょろぐ</title><link rel="canonical" href="https://blog.azyobuzi.net/2020/05/03/01-projectref/"><meta property="og:title" content="ProjectReference にバージョン範囲を指定したい"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.azyobuzi.net/2020/05/03/01-projectref/"><meta property="og:description" content="複数のプロジェクトをひとつのリポジトリで管理するとき、プロジェクト間の参照関係は csproj に <ProjectReference> を書くわけですが、ここで、このプロジェクトを NuGet パッケージ化するときのことを考えます。例えば、 A と B というプロジェクトがあり、 B が A に依存しているとします。このとき B を dotnet pack してできあがるパッケージの A への依存はどのようになるでしょうか？ 実際にやってみると、現在の A のバージョン以上という依存関係になります。

ここで、 A の現在のバージョンを 1.0.0 とします。 Semantic Versioning に従っていると考えると、もし 2.0.0 がリリースされたら、破壊的な変更が入っているかもしれません。それでも B から A への依存は 1.0.0 以上で良いのでしょうか？ と考えると、「以上」以外の柔軟な依存関係を指定したくなりませんか？ というわけで、 <ProjectReference> を使ったプロジェクト間参照で、柔軟なバージョン範囲指定をしたいというのが今回のお話です。"><meta property="og:article:published_time" content="2020-05-03T04:07+09:00"><meta property="og:article:modified_time" content="2021-09-24T23:30:48+09:00"><meta property="og:article:tag" content="tech"><meta property="og:article:tag" content="C#"></head><body><div class="container"><article class="article-page"><header><h1>ProjectReference にバージョン範囲を指定したい</h1><div class="article-meta"><i class="fa fa-pencil-square-o" aria-hidden="true" title="公開日"></i><span class="sr-only">公開日</span> <time datetime="2020-05-03T04:07+09:00" title="公開: 2020/05/03 04:07
最終更新: 2021/09/24 23:30">2020/05/03</time> ― <a href="https://github.com/azyobuzin/blog/commits/f65f19fde91f122e1a22aef151d43393af580acb/posts/2020/05/03/01-projectref" rel="external">History</a></div><div class="article-meta"><i class="fa fa-tags" aria-hidden="true" title="タグ"></i><span class="sr-only">タグ</span><ul class="article-tags"><li><a rel="tag" class="article-tag" href="/tags/tech/">tech</a></li><li><a rel="tag" class="article-tag" href="/tags/C%23/">C#</a></li></ul></div></header><div class="article-content"><p>複数のプロジェクトをひとつのリポジトリで管理するとき、プロジェクト間の参照関係は csproj に <code>&#x3C;ProjectReference></code> を書くわけですが、ここで、このプロジェクトを NuGet パッケージ化するときのことを考えます。例えば、 A と B というプロジェクトがあり、 B が A に依存しているとします。このとき B を <code>dotnet pack</code> してできあがるパッケージの A への依存はどのようになるでしょうか？ 実際にやってみると、現在の A のバージョン<strong>以上</strong>という依存関係になります。</p>
<p>ここで、 A の現在のバージョンを 1.0.0 とします。 Semantic Versioning に従っていると考えると、もし 2.0.0 がリリースされたら、破壊的な変更が入っているかもしれません。それでも B から A への依存は 1.0.0 <strong>以上</strong>で良いのでしょうか？ と考えると、「以上」以外の柔軟な依存関係を指定したくなりませんか？ というわけで、 <code>&#x3C;ProjectReference></code> を使ったプロジェクト間参照で、柔軟なバージョン範囲指定をしたいというのが今回のお話です。</p>
<h2>サンプルプロジェクト</h2>
<p>文章でだらだらと説明されても読みたくないのはわかります。ので、実際の csproj を示しておきます。</p>
<figure class="fig-code">
<figcaption>A/A.csproj</figcaption>
<pre><code class="language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Project</span> <span class="hljs-attr">Sdk</span>=<span class="hljs-string">"Microsoft.NET.Sdk"</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">PropertyGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">TargetFramework</span>></span>netstandard2.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">TargetFramework</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">Version</span>></span>1.0.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">Version</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">PropertyGroup</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">Project</span>></span>
</code></pre>
</figure>
<figure class="fig-code">
<figcaption>B/B.csproj</figcaption>
<pre><code class="language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Project</span> <span class="hljs-attr">Sdk</span>=<span class="hljs-string">"Microsoft.NET.Sdk"</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">PropertyGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">TargetFramework</span>></span>netstandard2.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">TargetFramework</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">PropertyGroup</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">ProjectReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"..\A\A.csproj"</span> /></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">Project</span>></span>
</code></pre>
</figure>
<p>ここで、 B に対して <code>dotnet pack</code> を実行したときの nuspec の <code>&#x3C;dependencies></code> はこのようになります。</p>
<pre><code class="language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">group</span> <span class="hljs-attr">targetFramework</span>=<span class="hljs-string">".NETStandard2.0"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"A"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0.0"</span> <span class="hljs-attr">exclude</span>=<span class="hljs-string">"Build,Analyzers"</span> /></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">group</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>
</code></pre>
<p><code>version="1.0.0"</code> という指定は、「1.0.0 以上」と解釈されます。</p>
<h2>目標設定</h2>
<p>ここでは、 Semantic Versioning という前提で、 B が依存するのは A v1.0.0 以上 2.0.0 未満、としましょう。こうすれば、 B が A の Public API のみに依存しているならば、 B はこの依存関係が解決できる限り、必ず動作するといえます。</p>
<h2>一筋縄で実現できたらブログ書いてない</h2>
<p>はい。これは NuGet の Issue (<a href="https://github.com/NuGet/Home/issues/5556">NuGet/Home#5556</a>) に挙がっており、現在も実現されていません。しかし頑張ればできないこともない状況になっています。</p>
<p>必要なものは <a href="https://dotnet.microsoft.com/download/dotnet/5.0">.NET 5.0 Preview SDK</a> (執筆時点で 5.0.100-preview.3.20216.6) です。最新の NuGet を搭載している SDK を使うと、 csproj に少し手を入れるだけで、 <code>&#x3C;ProjectReference></code> に対する依存関係に介入できるようになります。</p>
<h2>目標をクリアする csproj</h2>
<p>仕組みとかいいからとりあえず使いたいって人は、これをコピペしてください。バージョンの指定方法は、 NuGet のドキュメント (<a href="https://docs.microsoft.com/ja-jp/nuget/concepts/package-versioning#version-ranges"><cite>Version ranges</cite></a>) を確認してください。</p>
<pre><code class="language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Project</span> <span class="hljs-attr">Sdk</span>=<span class="hljs-string">"Microsoft.NET.Sdk"</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">PropertyGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">TargetFramework</span>></span>netstandard2.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">TargetFramework</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">PropertyGroup</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">ProjectReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"..\A\A.csproj"</span> /></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>

  <span class="hljs-comment">&#x3C;!-- 以下を追加 --></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">Target</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"SetDependencyVersion"</span> <span class="hljs-attr">AfterTargets</span>=<span class="hljs-string">"_GetProjectReferenceVersions"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">_ProjectReferencesWithVersions</span> <span class="hljs-attr">Update</span>=<span class="hljs-string">"..\A\A.csproj"</span> <span class="hljs-attr">ProjectVersion</span>=<span class="hljs-string">"[1.0.0,2.0.0)"</span> /></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">Target</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">Project</span>></span>
</code></pre>
<p>出力される nuspec の <code>&#x3C;dependencies></code> はこんな感じになります。</p>
<pre><code class="language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">group</span> <span class="hljs-attr">targetFramework</span>=<span class="hljs-string">".NETStandard2.0"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"A"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"[1.0.0, 2.0.0)"</span> <span class="hljs-attr">exclude</span>=<span class="hljs-string">"Build,Analyzers"</span> /></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">group</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>
</code></pre>
<h2>仕組み</h2>
<p><code>dotnet pack</code> (MSBuild で <code>Pack</code> ターゲットを実行する) では、 <code>&#x3C;ProjectReference></code> Item があったら、そのプロジェクトのバージョンを読み込み、 <code>&#x3C;_ProjectReferencesWithVersions></code> という Item を作成します。そこで、その処理が行われる <code>_GetProjectReferenceVersions</code> ターゲットの後に、読み込まれたバージョンを上書きするようなターゲットを作成することで、好きなバージョンに書き換えることができます。</p>
<p>ここまでは古い SDK でもできたのですが、古い SDK では <code>ProjectVersion</code> 属性にバージョンの<strong>範囲</strong>が指定されることを想定していませんでした。つまり <code>1.0.0</code> は受け付けるけど、 <code>[1.0.0,2.0.0)</code> は受け付けてくれなかったわけです。新しい SDK では、範囲を指定してもエラーにならないようになったので、このようなハックでお茶を濁せるようになりました。</p>
<h2>今後もっと簡単になるか？</h2>
<p><a href="https://github.com/NuGet/Home/issues/5556">NuGet/Home#5556</a> を監視していきましょう。</p>
<h2>NuGet に対するぼやき</h2>
<p>依存関係解決の戦略がデフォルトで「条件を満たす最小バージョン」な所為で、依存バージョンをすぐ「以上」にしてしまうのは NuGet の悪いところだなぁと思っています。そのおかげで lock ファイルを使わなくても、あまり崩壊しないという利点はありますが、少なくともリビジョンリリースは自動で最新にしてほしくない？ という思いがあります。</p></div></article><footer><nav><ul><li><a href="/">あじょろぐ</a></li><li><a href="https://twitter.com/azyobuzin" rel="author external">@azyobuzin</a></li></ul></nav></footer></div></body></html>