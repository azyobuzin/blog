<!DOCTYPE html><html lang="ja" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="generator" content="https://github.com/azyobuzin/blog"><link rel="stylesheet" href="https://unpkg.com/fork-awesome@~1.2.0/css/fork-awesome.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&#x26;family=Roboto:ital,wght@0,300;0,400;0,700;1,300;1,700&#x26;display=swap" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="/global.css"><meta property="og:site_name" content="あじょろぐ"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@azyobuzin"><title>Visual Studio と VSCode どちらでも使える Docker Compose 環境 | あじょろぐ</title><link rel="canonical" href="https://blog.azyobuzi.net/2020/09/28/01-vs-docker-compose/"><meta property="og:title" content="Visual Studio と VSCode どちらでも使える Docker Compose 環境"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.azyobuzi.net/2020/09/28/01-vs-docker-compose/"><meta property="og:description" content="開発環境を Docker でいい感じにしてくれるやつとして、 Visual Studio では「コンテナー開発ツール」が、 Visual Studio Code には Remote 拡張があります。これらは Dockerfile や docker-compose.yml を用意すると、その中でアプリを動かすことができるやつです。しかし、同じものではないので、挙動はまったく異なります。それぞれメリット、デメリットがあるので、両方使えるとうれしいわけです。そこで、うまいこと両方で使える docker-compose.yml を書いてみようという試みをやっていきます。"><meta property="og:article:published_time" content="2020-09-28T02:29+09:00"><meta property="og:article:modified_time" content="2021-09-24T23:30:48+09:00"><meta property="og:article:tag" content="tech"><meta property="og:article:tag" content="C#"><meta property="og:article:tag" content="Docker"></head><body><div class="container"><article class="article-page"><header><h1>Visual Studio と VSCode どちらでも使える Docker Compose 環境</h1><div class="article-meta"><i class="fa fa-pencil-square-o" aria-hidden="true" title="公開日"></i><span class="sr-only">公開日</span> <time datetime="2020-09-28T02:29+09:00" title="公開: 2020/09/28 02:29
最終更新: 2021/09/24 23:30">2020/09/28</time> ― <a href="https://github.com/azyobuzin/blog/commits/f65f19fde91f122e1a22aef151d43393af580acb/posts/2020/09/28/01-vs-docker-compose" rel="external">History</a></div><div class="article-meta"><i class="fa fa-tags" aria-hidden="true" title="タグ"></i><span class="sr-only">タグ</span> <a class="button button-outline article-tag" href="/tags/tech/">tech</a> <a class="button button-outline article-tag" href="/tags/C%23/">C#</a> <a class="button button-outline article-tag" href="/tags/Docker/">Docker</a></div></header><div class="article-content"><p>開発環境を Docker でいい感じにしてくれるやつとして、 Visual Studio では「コンテナー開発ツール」が、 Visual Studio Code には Remote 拡張があります。これらは Dockerfile や docker-compose.yml を用意すると、その中でアプリを動かすことができるやつです。しかし、同じものではないので、挙動はまったく異なります。それぞれメリット、デメリットがあるので、両方使えるとうれしいわけです。そこで、うまいこと両方で使える docker-compose.yml を書いてみようという試みをやっていきます。</p>
<h2>それぞれのメリット、デメリット</h2>
<p>コンテナ化、特に Docker Compose を使いたい理由として、クラサバ型データベースを開発環境に置きたいという欲求があります。適当にデバッグ実行したら適当なデータベースが動いていると便利です。というわけで、今回は PostgreSQL コンテナとアプリ開発環境が共存することを目標とします。</p>
<p>Visual Studio の Docker 連携は、コンテナにビルド結果とデバッガーの口をマウントして、コンテナ内でアプリを実行してくれます。メリットは、開発環境はホストにあるので、 Visual Studio をフルに使えることです。デメリットは、コンテナ内に入って何か操作するというのが面倒なところです。</p>
<p>VSCode Remote は、コンテナの中で VSCode が動きます。ホストのディレクトリをコンテナにマウントすることで、ホストのファイルを編集できます。メリットは、 VSCode のターミナルからコンテナ内を触り放題なところです。例えば Windows で開発していて、 Linux で動かしたい開発ツールがあるときには便利です。デメリットは、 Visual Studio に慣れた人間にとって、 VSCode の C# 拡張は不足を感じるところです。</p>
<p>データベースを置くという今回の仮定では、データベースを手で操作するときに簡単に環境に入るために VSCode を使いたいものの、メインの開発は Visual Studio でしたい、となり、共存させたい欲求が発生しています。</p>
<h2>やっていく</h2>
<h3>1. Visual Studio で連携を設定する</h3>
<p>ここで説明する手順を実行するには、 Visual Studio 2019 で「ASP.NET と Web 開発」または「.NET Core クロスプラットフォームの開発」ワークロードがインストールされている必要があります。</p>
<p>ソリューションエクスプローラーで、 Docker で動かしたいプロジェクトを右クリックし、「コンテナー オーケストレーターのサポート」を追加します。</p>
<figure class="fig-img"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/azyobuzin/20200928/20200928004102.png" alt="「コンテナー オーケストレーターのサポート」を追加"></figure>
<p>いろいろ聞かれますが、 OS は Linux、ツールは Docker Compose としておけば OK です。</p>
<p>完了すると、 Dockerfile と「docker-compose」というプロジェクトが生えます。</p>
<figure class="fig-img"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/azyobuzin/20200928/20200928004106.png" alt="完了後のソリューション"></figure>
<p>これで、必要なファイルを Visual Studio に自動生成させることができました。ここから先は生成されたファイル書き換えたり移動させたりして VSCode にフィットさせていきましょう。</p>
<h3>2. Dockerfile を改変する</h3>
<p>生成された Dockerfile を確認すると、本番ビルド用のスクリプトが書かれています。今回はこれを完全に捨てることにします。ただ、プロジェクトディレクトリ下に Dockerfile がないと Visual Studio が認識してくれないので、ここに開発環境を作成するスクリプトを書きましょう。本番用 Dockerfile はどこか別のところに置いてください……。</p>
<p>最低限必要なのは <code>FROM mcr.microsoft.com/dotnet/core/sdk:3.1-buster</code> だけです。「buster」のところは好きなディストリビューションに変えてください。必要に応じて、例えば今回の仮定ならば postgresql-client を入れたりするのもいいでしょう。</p>
<h3>3. docker-compose.yml を改変する</h3>
<p>ここからの操作は Visual Studio を破壊するので、すべてが完了するまで Visual Studio は閉じておきましょう。</p>
<p>いま、ソリューションディレクトリ直下に「docker-compose.yml」と「docker-compose.override.yml」があります。直下にあってもわかりにくいので、後で devcontainer.json というファイルを入れることになる .devcontainer というディレクトリをつくっておき、そこに移動させます。</p>
<figure class="fig-img"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/azyobuzin/20200928/20200928010233.png" alt="docker-compose.yml を .devcontainer へ移動"></figure>
<p>さらに、 docker-compose.override.yml という名前だと Visual Studio 用なのか VSCode 用なのかわかりにくいので、 docker-compose.vs.yml に改名しておくといいでしょう。</p>
<p>いま docker-compose.yml の中身はこのようになっていると思います。</p>
<figure class="fig-code">
<figcaption>docker-compose.yml</figcaption>
<pre><code class="language-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.4"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mydatabaseapp:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">${DOCKER_REGISTRY-}mydatabaseapp</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">MyDatabaseApp/Dockerfile</span>
</code></pre>
</figure>
<p>改変が必要なポイントは次のふたつです。</p>
<ul>
<li><code>build.context</code> のパスを正しく直す。 docker-compose.yml を移動したので、それに合わせます。</li>
<li>PostgreSQL を追加する。</li>
</ul>
<p>改変結果はこんな感じです。 docker-compose.yml の構文バージョンやプロジェクト名は、環境に合わせて書き換えてください。</p>
<figure class="fig-code">
<figcaption>docker-compose.yml</figcaption>
<pre><code class="language-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.4"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mydatabaseapp:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">..</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">MyDatabaseApp/Dockerfile</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:11</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./db/data:/var/lib/postgresql/data</span>
</code></pre>
</figure>
<p>データベースのデータの永続化は、ホストのパスを指定するか、この docker-compose.yml の外で作成したボリュームを割り当ててください。でないと、 VS と VSCode で Docker Compose のプロジェクト名が異なるので、同じデータを見てくれません。</p>
<h3>4. docker-compose.dcproj を改変する</h3>
<p>docker-compose.yml を移動したので、 docker-compose.dcproj も書き換えます。これもソリューションディレクトリ直下にあると邪魔なので .devcontainer に移動させてしまいましょう。</p>
<p>さらにファイル名変更を反映して、ディレクトリ外に行ってしまった .dockerignore をプロジェクトから消します。</p>
<figure class="fig-code">
<figcaption>docker-compose.dcproj</figcaption>
<pre><code class="language-diff"> &#x3C;?xml version="1.0" encoding="utf-8"?>
 &#x3C;Project ToolsVersion="15.0" Sdk="Microsoft.Docker.Sdk">
   &#x3C;PropertyGroup Label="Globals">
     &#x3C;ProjectVersion>2.1&#x3C;/ProjectVersion>
     &#x3C;DockerTargetOS>Linux&#x3C;/DockerTargetOS>
     &#x3C;ProjectGuid>3caba81b-3f76-4ecf-9907-78b96280d41c&#x3C;/ProjectGuid>
   &#x3C;/PropertyGroup>
   &#x3C;ItemGroup>
<span class="hljs-deletion">-    &#x3C;None Include="docker-compose.override.yml"></span>
<span class="hljs-addition">+    &#x3C;None Include="docker-compose.vs.yml"></span>
       &#x3C;DependentUpon>docker-compose.yml&#x3C;/DependentUpon>
     &#x3C;/None>
     &#x3C;None Include="docker-compose.yml" />
<span class="hljs-deletion">-    &#x3C;None Include=".dockerignore" /></span>
   &#x3C;/ItemGroup>
 &#x3C;/Project>
</code></pre>
</figure>
<p>またソリューションファイルもパスを書き換えます。</p>
<figure class="fig-code">
<figcaption>MyDatabaseApp.sln</figcaption>
<pre><code class="language-diff"><span class="hljs-deletion">-Project("{E53339B2-1760-4266-BCC7-CA923CBCF16C}") = "docker-compose", "docker-compose.dcproj", "{3CABA81B-3F76-4ECF-9907-78B96280D41C}"</span>
<span class="hljs-addition">+Project("{E53339B2-1760-4266-BCC7-CA923CBCF16C}") = "docker-compose", ".devcontainer\docker-compose.dcproj", "{3CABA81B-3F76-4ECF-9907-78B96280D41C}"</span>
</code></pre>
</figure>
<h3>5. VSCode 向けの docker-compose.yml をつくる</h3>
<p>VSCode 向けに .devcontainer/docker-compose.vscode.yml を作っていきます。ポイントは次のふたつです。</p>
<ul>
<li>コンテナが終了しないように無限ループさせる</li>
<li>作業ディレクトリをマウントする</li>
</ul>
<p>実際の YAML で表すとこれだけです。</p>
<figure class="fig-code">
<figcaption>docker-compose.vscode.yml</figcaption>
<pre><code class="language-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.4"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mydatabaseapp:</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/sh</span> <span class="hljs-string">-c</span> <span class="hljs-string">"while sleep 1000; do :; done"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">..:/workspace:cached</span>
</code></pre>
</figure>
<p>必要に応じて、ポートを公開するために <code>ports</code> を追加したりしてください。</p>
<p>参考: <a href="https://bufferings.hatenablog.com/entry/2020/06/11/233201"><cite>VS Code Remote - Containers を Docker Compose で使うのだー！ - Mitsuyuki.Shiiba</cite></a></p>
<h3>6. devcontainer.json をつくる</h3>
<p>devcontainer.json は VSCode にコンテナ作成を指示する設定ファイルです。これも .devcontainer に置きます。</p>
<p>最小限の devcontainer.json はこんな感じです。</p>
<figure class="fig-code">
<figcaption>devcontainer.json</figcaption>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dockerComposeFile"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"docker-compose.yml"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"docker-compose.vscode.yml"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>

  <span class="hljs-comment">// docker-compose.yml の services のうち、開発環境につかうもの</span>
  <span class="hljs-attr">"service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mydatabaseapp"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-comment">// docker-compose.vscode.yml で指定したマウント先</span>
  <span class="hljs-attr">"workspaceFolder"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/workspace"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-comment">// 事前にインストールしておいてほしい拡張</span>
  <span class="hljs-attr">"extensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ms-dotnettools.csharp"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</figure>
<p>いじり倒したいときは <a href="https://code.visualstudio.com/docs/remote/devcontainerjson-reference"><cite>devcontainer.json reference</cite></a> を読むといいでしょう。</p>
<h3>完成！</h3>
<p>これで準備完了です。 VSCode で「Reopen in Container」を実行すると、コンテナ上で VSCode が動き始めます。 Dockerfile のビルドが走るので気長に待ちましょう。</p>
<p>また、 Visual Studio でも docker-compose プロジェクトをスタートアッププロジェクトに設定して実行できるはずです！</p>
<div class="admonitionblock caution" role="note"><div class="icon">Caution</div><div class="content">
<p>Visual Studio と VSCode の同時実行は危険です。同じマウント先のデータベースがふたつ動くことになってしまいます。また、それぞれ終了後 30 秒くらいはコンテナが動いているので、コンテナが終了されたことを確認してから、他方を使ってください。</p>
</div></div>
<h2>まとめ</h2>
<p>頑張れば Visual Studio でも VSCode でも使える Docker Compose 環境がつくれることを示しました。これで開発が捗ればいいね。捗らんか……。</p>
<p>ここまでの内容を clone するだけでお試しできるものを GitHub に置いておきました。</p>
<p><a href="https://github.com/azyobuzin/vs-docker-compose-example">azyobuzin/vs-docker-compose-example</a></p></div></article><footer><hr><nav><ul><li><a href="/">あじょろぐ</a></li><li><a href="https://twitter.com/azyobuzin" rel="author external">@azyobuzin</a></li></ul></nav></footer></div></body></html>